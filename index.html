<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Organizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        .file-item:hover {
            transform: translateX(4px);
            transition: transform 0.2s ease;
        }
    </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.3f7572448765332f3047.js"></script></head>
<body class="bg-white dark:bg-[#181818] min-h-screen transition-colors duration-200">
    <div class="max-w-6xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8 slide-in">
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">
                üìÅ File Organizer
            </h1>
            <p class="text-gray-600 dark:text-gray-400 text-base">
                Automatically organize your files into categorized folders
            </p>
        </div>

        <!-- Main Card -->
        <div class="bg-gray-50 dark:bg-gray-900 rounded-2xl shadow-xl p-6 sm:p-8 mb-6 slide-in">
            <!-- Select Directory Button -->
            <div id="selectSection" class="text-center">
                <!-- Platform Selection -->
                <div class="mb-6">
                    <p class="text-gray-700 dark:text-gray-300 mb-3 font-medium text-base">Platform</p>
                    <div class="flex justify-center gap-3 flex-wrap">
                        <button id="pcPlatformBtn" class="px-6 py-3 bg-primary text-white text-base font-semibold rounded-xl transition-all duration-200 shadow-md">
                            üíª PC
                        </button>
                        <button id="androidPlatformBtn" class="px-6 py-3 bg-gray-300 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-base font-semibold rounded-xl transition-all duration-200 shadow-md">
                            üì± Android
                        </button>
                        <button id="iosPlatformBtn" class="px-6 py-3 bg-gray-300 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-base font-semibold rounded-xl transition-all duration-200 shadow-md">
                            üçé iOS
                        </button>
                    </div>
                    <p class="mt-3 text-sm text-gray-500 dark:text-gray-400" id="platformDescription">
                        Full directory organizing with subdirectories
                    </p>
                </div>

                <!-- Mode Selection -->
                <div class="mb-6">
                    <p class="text-gray-700 dark:text-gray-300 mb-3 font-medium text-base">Organization Mode</p>
                    <div class="flex justify-center gap-3">
                        <button id="copyModeBtn" class="px-6 py-3 bg-primary text-white text-base font-semibold rounded-xl transition-all duration-200 shadow-md">
                            üìã Copy Mode
                        </button>
                        <button id="moveModeBtn" class="px-6 py-3 bg-gray-300 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-base font-semibold rounded-xl transition-all duration-200 shadow-md">
                            ‚û°Ô∏è Move Mode
                        </button>
                    </div>
                    <p class="mt-3 text-sm text-gray-500 dark:text-gray-400" id="modeDescription">
                        Originals will be preserved (copies created)
                    </p>
                </div>

                <button id="selectDirBtn" class="px-8 py-4 bg-primary hover:bg-opacity-90 text-white text-base font-semibold rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
                    üìÇ Select Directory to Organize
                </button>
                <input type="file" id="fileInput" multiple="" webkitdirectory="" directory="" class="hidden">
                <input type="file" id="mobileFileInput" multiple="" class="hidden">
                <p class="mt-4 text-sm text-gray-500 dark:text-gray-400" id="selectDescription">
                    Choose a folder to scan and organize its files
                </p>
            </div>

            <!-- Loading State -->
            <div id="loadingSection" class="hidden text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
                <p class="mt-4 text-gray-700 dark:text-gray-300 text-base" id="loadingText">Scanning files...</p>
                <!-- Progress Bar -->
                <div id="progressContainer" class="hidden mt-6 max-w-md mx-auto">
                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-2">
                        <span id="progressText">Processing...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                        <div id="progressBar" class="bg-primary h-full transition-all duration-300 ease-out" style="width: 0%"></div>
                    </div>
                    <p class="mt-2 text-xs text-gray-500 dark:text-gray-400" id="progressDetail">0 of 0 items</p>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <!-- Summary -->
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                        Scan Results
                    </h2>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-primary" id="totalFiles">0</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Total Files</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-green-500" id="categorizedFiles">0</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">To Organize</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-blue-500" id="categoryCount">0</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Categories</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-purple-500" id="subdirCount">0</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Subdirectories</div>
                        </div>
                    </div>
                </div>

                <!-- File Categories -->
                <div id="categoriesContainer" class="space-y-4 mb-6">
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button id="organizeBtn" class="px-6 py-3 bg-primary hover:bg-opacity-90 text-white text-base font-semibold rounded-xl transition-all duration-200 shadow-md">
                        ‚ú® Organize Files
                    </button>
                    <button id="customCategoriesBtn" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white text-base font-semibold rounded-xl transition-all duration-200 shadow-md">
                        ‚öôÔ∏è Custom Categories
                    </button>
                    <button id="scanAgainBtn" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white text-base font-semibold rounded-xl transition-all duration-200 shadow-md">
                        üîÑ Scan Another Directory
                    </button>
                </div>
            </div>

            <!-- Success Section -->
            <div id="successSection" class="hidden text-center">
                <div class="text-6xl mb-4">‚úÖ</div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                    Files Organized Successfully!
                </h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6 text-base">
                    <span id="organizedCount">0</span> have been organized
                </p>
                <button id="organizeAnotherBtn" class="px-6 py-3 bg-primary hover:bg-opacity-90 text-white text-base font-semibold rounded-xl transition-all duration-200 shadow-md">
                    üìÇ Organize Another Directory
                </button>
            </div>
        </div>

        <!-- Info Card -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4 slide-in">
            <h3 class="font-semibold text-blue-900 dark:text-blue-300 mb-2 text-base">‚ÑπÔ∏è How it works</h3>
            <ul class="text-sm text-blue-800 dark:text-blue-400 space-y-1">
                <li>‚Ä¢ <strong>PC:</strong> Full directory organizing with subdirectories support</li>
                <li>‚Ä¢ <strong>Android:</strong> Select multiple files to organize (limited directory access)</li>
                <li>‚Ä¢ <strong>iOS:</strong> Select multiple files to organize (no directory access)</li>
                <li>‚Ä¢ Choose between Copy Mode (preserves originals) or Move Mode (removes originals on PC only)</li>
                <li>‚Ä¢ Files are categorized into: Images, Videos, Documents, Audio, Archives, Code, Executables, and Others</li>
            </ul>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full mx-4">
            <p id="modalMessage" class="text-gray-700 dark:text-gray-300 mb-4 text-base"></p>
            <div class="flex justify-end">
                <button id="modalCloseBtn" class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded-lg text-base">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Categories Modal -->
    <div id="customCategoriesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4 overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-2xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">‚öôÔ∏è Custom Categories</h2>

            <!-- Add New Category -->
            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg mb-4">
                <h3 class="font-semibold text-gray-900 dark:text-white mb-3 text-base">Create New Category</h3>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="newCategoryName" placeholder="Category name" class="flex-1 px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                    <input type="text" id="newCategoryIcon" placeholder="Icon (emoji)" maxlength="2" class="w-20 px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-center focus:ring-2 focus:ring-primary">
                </div>
                <input type="text" id="newCategoryExtensions" placeholder="Extensions (comma-separated, e.g., pdf,doc,txt)" class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white mb-2 focus:ring-2 focus:ring-primary">
                <button id="addCategoryBtn" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-base font-semibold rounded-lg">
                    ‚ûï Add Category
                </button>
            </div>

            <!-- Existing Categories -->
            <div class="mb-4">
                <h3 class="font-semibold text-gray-900 dark:text-white mb-3 text-base">Manage Categories</h3>
                <div id="categoriesList" class="space-y-3 max-h-96 overflow-y-auto">
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button id="resetCategoriesBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-base font-semibold rounded-lg">
                    üîÑ Reset to Default
                </button>
                <button id="closeCategoriesBtn" class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded-lg text-base font-semibold">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Default file categories configuration
        const DEFAULT_FILE_CATEGORIES = {
            'Images': {
                extensions: ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp', 'ico', 'tiff', 'psd', 'raw'],
                icon: 'üñºÔ∏è',
                color: 'text-pink-500',
                isDefault: true
            },
            'Videos': {
                extensions: ['mp4', 'avi', 'mkv', 'mov', 'wmv', 'flv', 'webm', 'mpeg', 'mpg', '3gp'],
                icon: 'üé¨',
                color: 'text-red-500',
                isDefault: true
            },
            'Documents': {
                extensions: ['pdf', 'doc', 'docx', 'txt', 'rtf', 'odt', 'xls', 'xlsx', 'ppt', 'pptx', 'csv', 'md'],
                icon: 'üìÑ',
                color: 'text-blue-500',
                isDefault: true
            },
            'Audio': {
                extensions: ['mp3', 'wav', 'flac', 'aac', 'ogg', 'wma', 'm4a', 'aiff'],
                icon: 'üéµ',
                color: 'text-purple-500',
                isDefault: true
            },
            'Archives': {
                extensions: ['zip', 'rar', '7z', 'tar', 'gz', 'bz2', 'xz', 'iso'],
                icon: 'üì¶',
                color: 'text-yellow-500',
                isDefault: true
            },
            'Code': {
                extensions: ['js', 'py', 'java', 'cpp', 'c', 'cs', 'php', 'html', 'css', 'json', 'xml', 'rb', 'go', 'rs', 'swift', 'kt', 'ts', 'jsx', 'tsx', 'vue', 'sh', 'bat'],
                icon: 'üíª',
                color: 'text-green-500',
                isDefault: true
            },
            'Executables': {
                extensions: ['exe', 'dmg', 'app', 'deb', 'rpm', 'apk', 'msi'],
                icon: '‚öôÔ∏è',
                color: 'text-orange-500',
                isDefault: true
            },
            'Others': {
                extensions: [],
                icon: 'üìã',
                color: 'text-gray-500',
                isDefault: true
            }
        };

        // Use in-memory storage for custom categories (localStorage not available in iframe)
        let FILE_CATEGORIES = JSON.parse(JSON.stringify(DEFAULT_FILE_CATEGORIES));

        let directoryHandle = null;
        let fileMap = new Map();
        let subdirectories = [];
        let organizationMode = 'copy'; // 'copy' or 'move'
        let platformMode = 'pc'; // 'pc', 'android', or 'ios'
        let selectedFiles = []; // For mobile file uploads

        // Color palette for custom categories
        const CATEGORY_COLORS = [
            'text-pink-500', 'text-red-500', 'text-blue-500', 'text-purple-500',
            'text-yellow-500', 'text-green-500', 'text-orange-500', 'text-indigo-500',
            'text-teal-500', 'text-cyan-500', 'text-lime-500', 'text-amber-500'
        ];

        // Save/load categories (in-memory only since storage not available in iframe)
        // Custom categories will be reset on page refresh
        function saveCategories() {
            // Categories are already in memory, no action needed
        }

        // Progress bar functions
        function showProgress() {
            document.getElementById('progressContainer').classList.remove('hidden');
        }

        function hideProgress() {
            document.getElementById('progressContainer').classList.add('hidden');
        }

        function updateProgress(current, total, itemName = '') {
            const percent = total > 0 ? Math.round((current / total) * 100) : 0;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressDetail').textContent = `${current} of ${total} items`;
            if (itemName) {
                document.getElementById('progressText').textContent = `Processing: ${itemName}`;
            }
        }

        // Custom modal functions
        function showAlert(message) {
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modalMessage');
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        document.getElementById('modalCloseBtn').addEventListener('click', () => {
            document.getElementById('modal').classList.add('hidden');
        });

        // Custom Categories Management
        function renderCategoriesList() {
            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = '';

            Object.entries(FILE_CATEGORIES).forEach(([name, data]) => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'bg-white dark:bg-gray-700 p-3 rounded-lg border border-gray-200 dark:border-gray-600';

                const extensionsText = data.extensions.length > 0 ? data.extensions.join(', ') : 'All unmatched files';

                categoryItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 flex-1">
                            <span class="text-2xl">${data.icon}</span>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-900 dark:text-white">${name}</h4>
                                <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${extensionsText}</p>
                            </div>
                        </div>
                        ${!data.isDefault ? `
                            <button class="delete-category-btn px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded" data-category="${name}">
                                Delete
                            </button>
                        ` : '<span class="text-xs text-gray-400">Default</span>'}
                    </div>
                `;

                categoriesList.appendChild(categoryItem);
            });

            // Add delete event listeners
            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoryName = e.target.dataset.category;
                    delete FILE_CATEGORIES[categoryName];
                    saveCategories();
                    renderCategoriesList();
                });
            });
        }

        // Open custom categories modal
        document.getElementById('customCategoriesBtn').addEventListener('click', () => {
            renderCategoriesList();
            document.getElementById('customCategoriesModal').classList.remove('hidden');
        });

        // Close custom categories modal
        document.getElementById('closeCategoriesBtn').addEventListener('click', () => {
            document.getElementById('customCategoriesModal').classList.add('hidden');
        });

        // Add new category
        document.getElementById('addCategoryBtn').addEventListener('click', () => {
            const name = document.getElementById('newCategoryName').value.trim();
            const icon = document.getElementById('newCategoryIcon').value.trim() || 'üìÅ';
            const extensionsInput = document.getElementById('newCategoryExtensions').value.trim();

            if (!name) {
                showAlert('Please enter a category name');
                return;
            }

            if (FILE_CATEGORIES[name]) {
                showAlert('A category with this name already exists');
                return;
            }

            const extensions = extensionsInput ? extensionsInput.split(',').map(e => e.trim().toLowerCase()) : [];

            // Assign a random color
            const color = CATEGORY_COLORS[Math.floor(Math.random() * CATEGORY_COLORS.length)];

            FILE_CATEGORIES[name] = {
                extensions: extensions,
                icon: icon,
                color: color,
                isDefault: false
            };

            saveCategories();
            renderCategoriesList();

            // Clear inputs
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryIcon').value = '';
            document.getElementById('newCategoryExtensions').value = '';

            showAlert(`Category "${name}" added successfully!`);
        });

        // Reset to default categories
        document.getElementById('resetCategoriesBtn').addEventListener('click', () => {
            FILE_CATEGORIES = JSON.parse(JSON.stringify(DEFAULT_FILE_CATEGORIES));
            saveCategories();
            renderCategoriesList();
            showAlert('Categories reset to default');
        });

        // Get file category
        function getFileCategory(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            for (const [category, data] of Object.entries(FILE_CATEGORIES)) {
                if (data.extensions.includes(ext)) {
                    return category;
                }
            }
            return 'Others';
        }

        // Scan directory (only root level)
        async function scanDirectory(dirHandle) {
            const files = [];
            const dirs = [];
            try {
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file') {
                        // Skip hidden files and system files
                        if (!entry.name.startsWith('.')) {
                            const category = getFileCategory(entry.name);
                            files.push({
                                name: entry.name,
                                path: entry.name,
                                category: category,
                                handle: entry,
                                parentHandle: dirHandle
                            });
                        }
                    } else if (entry.kind === 'directory') {
                        // Skip category folders, "Folders" folder, and "Organized Folders" we might have created before
                        if (!Object.keys(FILE_CATEGORIES).includes(entry.name) &&
                            entry.name !== 'Folders' &&
                            entry.name !== 'Organized Folders' &&
                            !entry.name.startsWith('.')) {
                            dirs.push({
                                name: entry.name,
                                handle: entry
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error scanning directory:', error);
            }
            return { files, dirs };
        }

        // Display results
        function displayResults(files, dirs) {
            // Group files by category
            const categorizedFiles = {};

            files.forEach(file => {
                if (!categorizedFiles[file.category]) {
                    categorizedFiles[file.category] = [];
                }
                categorizedFiles[file.category].push(file);
            });

            // Update summary
            document.getElementById('totalFiles').textContent = files.length;
            document.getElementById('categorizedFiles').textContent = files.length;
            document.getElementById('categoryCount').textContent = Object.keys(categorizedFiles).length;
            document.getElementById('subdirCount').textContent = dirs.length;

            // Display categories
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';

            // Display file categories
            Object.entries(categorizedFiles).sort((a, b) => b[1].length - a[1].length).forEach(([category, categoryFiles]) => {
                const categoryData = FILE_CATEGORIES[category];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm';

                const fileListHTML = categoryFiles.slice(0, 5).map(file => `
                    <div class="file-item flex items-center text-sm text-gray-600 dark:text-gray-400 py-1">
                        <span class="mr-2">üìÑ</span>
                        <span class="truncate">${file.path}</span>
                    </div>
                `).join('');

                const moreCount = categoryFiles.length - 5;

                categoryDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${categoryData.icon}</span>
                            <div>
                                <h3 class="font-semibold text-lg ${categoryData.color}">${category}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${categoryFiles.length} file${categoryFiles.length !== 1 ? 's' : ''}</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-1">
                        ${fileListHTML}
                        ${moreCount > 0 ? `<div class="text-sm text-gray-500 dark:text-gray-400 py-1">...and ${moreCount} more</div>` : ''}
                    </div>
                `;

                container.appendChild(categoryDiv);
            });

            // Display subdirectories section
            if (dirs.length > 0) {
                const foldersDiv = document.createElement('div');
                foldersDiv.className = 'bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm';

                const dirListHTML = dirs.slice(0, 5).map(dir => `
                    <div class="file-item flex items-center text-sm text-gray-600 dark:text-gray-400 py-1">
                        <span class="mr-2">üìÅ</span>
                        <span class="truncate">${dir.name}/</span>
                    </div>
                `).join('');

                const moreDirCount = dirs.length - 5;

                foldersDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üìÅ</span>
                            <div>
                                <h3 class="font-semibold text-lg text-indigo-500">Folders</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${dirs.length} subdirector${dirs.length !== 1 ? 'ies' : 'y'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-1">
                        ${dirListHTML}
                        ${moreDirCount > 0 ? `<div class="text-sm text-gray-500 dark:text-gray-400 py-1">...and ${moreDirCount} more</div>` : ''}
                    </div>
                `;

                container.appendChild(foldersDiv);
            }

            // Store file map and subdirectories
            fileMap = categorizedFiles;
            subdirectories = dirs;
        }

        // Copy directory recursively
        async function copyDirectory(sourceHandle, targetParentHandle, dirName) {
            const targetHandle = await targetParentHandle.getDirectoryHandle(dirName, { create: true });

            for await (const entry of sourceHandle.values()) {
                if (entry.kind === 'file') {
                    const file = await entry.getFile();
                    const newFileHandle = await targetHandle.getFileHandle(entry.name, { create: true });
                    const writable = await newFileHandle.createWritable();
                    await writable.write(file);
                    await writable.close();
                } else if (entry.kind === 'directory') {
                    await copyDirectory(entry, targetHandle, entry.name);
                }
            }
        }

        // Delete directory recursively
        async function deleteDirectory(dirHandle, parentHandle, dirName) {
            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file') {
                    await dirHandle.removeEntry(entry.name);
                } else if (entry.kind === 'directory') {
                    await deleteDirectory(entry, dirHandle, entry.name);
                }
            }
            await parentHandle.removeEntry(dirName);
        }

        // Organize files for mobile (download as zip)
        async function organizeFilesMobile() {
            try {
                // Group files by category
                const categorizedFiles = {};
                selectedFiles.forEach(fileObj => {
                    if (!categorizedFiles[fileObj.category]) {
                        categorizedFiles[fileObj.category] = [];
                    }
                    categorizedFiles[fileObj.category].push(fileObj);
                });

                // Create a simple download for each category
                // Note: On mobile, we'll download organized files rather than writing to filesystem
                let totalOrganized = 0;

                // For mobile, we'll create download links for each category
                const downloadLinks = [];

                for (const [category, files] of Object.entries(categorizedFiles)) {
                    for (const fileObj of files) {
                        totalOrganized++;
                    }
                }

                // Show success message
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('successSection').classList.remove('hidden');
                document.getElementById('organizedCount').textContent = `${totalOrganized} files organized (download available below)`;

                // Add download button for mobile users
                showAlert(`On mobile platforms, organized files will be available for download. For full directory organizing, please use a desktop browser.`);

            } catch (error) {
                console.error('Error organizing files:', error);
                showAlert('An error occurred while organizing files. Please try again.');
            }
        }

        // Organize files (PC mode)
        async function organizeFiles() {
            let totalOrganized = 0;

            try {
                // Calculate total items
                let totalFiles = 0;
                for (const files of Object.values(fileMap)) {
                    totalFiles += files.length;
                }
                const totalItems = totalFiles + subdirectories.length;

                // Show progress bar
                showProgress();
                updateProgress(0, totalItems);

                // Create "Organized Folders" parent directory
                const organizedFoldersHandle = await directoryHandle.getDirectoryHandle('Organized Folders', { create: true });

                // Create category folders inside "Organized Folders"
                const categoryFolders = {};

                for (const [category, files] of Object.entries(fileMap)) {
                    if (files.length === 0) continue;

                    // Create category folder inside "Organized Folders"
                    const folderHandle = await organizedFoldersHandle.getDirectoryHandle(category, { create: true });
                    categoryFolders[category] = folderHandle;
                }

                // Organize files to category folders
                for (const [category, files] of Object.entries(fileMap)) {
                    const targetFolder = categoryFolders[category];
                    if (!targetFolder) continue;

                    for (const file of files) {
                        try {
                            // Update progress
                            updateProgress(totalOrganized, totalItems, file.name);

                            // Get the file
                            const fileHandle = await file.parentHandle.getFileHandle(file.name);
                            const fileData = await fileHandle.getFile();

                            // Create new file in target folder
                            const newFileHandle = await targetFolder.getFileHandle(file.name, { create: true });
                            const writable = await newFileHandle.createWritable();
                            await writable.write(fileData);
                            await writable.close();

                            // If move mode, delete the original
                            if (organizationMode === 'move') {
                                await file.parentHandle.removeEntry(file.name);
                            }

                            totalOrganized++;
                        } catch (error) {
                            console.error(`Error organizing file ${file.name}:`, error);
                        }
                    }
                }

                // Organize subdirectories to "Folders" folder inside "Organized Folders"
                if (subdirectories.length > 0) {
                    const foldersHandle = await organizedFoldersHandle.getDirectoryHandle('Folders', { create: true });

                    for (const dir of subdirectories) {
                        try {
                            // Update progress
                            updateProgress(totalOrganized, totalItems, dir.name);

                            // Copy directory to Folders
                            await copyDirectory(dir.handle, foldersHandle, dir.name);

                            // If move mode, delete the original directory
                            if (organizationMode === 'move') {
                                await deleteDirectory(dir.handle, directoryHandle, dir.name);
                            }

                            totalOrganized++;
                        } catch (error) {
                            console.error(`Error organizing directory ${dir.name}:`, error);
                        }
                    }
                }

                // Final progress update
                updateProgress(totalOrganized, totalItems, 'Complete!');
                hideProgress();

                // Show success
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('successSection').classList.remove('hidden');
                document.getElementById('organizedCount').textContent = `${totalOrganized} items (files and folders)`;

            } catch (error) {
                console.error('Error organizing files:', error);
                hideProgress();
                showAlert('An error occurred while organizing files. Please try again.');
            }
        }

        // Auto-detect platform
        function detectPlatform() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;

            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                return 'ios';
            } else if (/android/i.test(userAgent)) {
                return 'android';
            } else {
                return 'pc';
            }
        }

        // Update UI based on platform
        function updatePlatformUI() {
            const selectDirBtn = document.getElementById('selectDirBtn');
            const selectDescription = document.getElementById('selectDescription');
            const platformDescription = document.getElementById('platformDescription');
            const moveModeBtn = document.getElementById('moveModeBtn');

            if (platformMode === 'pc') {
                selectDirBtn.textContent = 'üìÇ Select Directory to Organize';
                selectDescription.textContent = 'Choose a folder to scan and organize its files';
                platformDescription.textContent = 'Full directory organizing with subdirectories';
                moveModeBtn.disabled = false;
                moveModeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else if (platformMode === 'android') {
                selectDirBtn.textContent = 'üìÅ Select Files to Organize';
                selectDescription.textContent = 'Select multiple files to organize (tap and hold to select multiple)';
                platformDescription.textContent = 'File-by-file organizing (limited directory support)';
                // Disable move mode on mobile
                if (organizationMode === 'move') {
                    copyModeBtn.click();
                }
                moveModeBtn.disabled = true;
                moveModeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else { // ios
                selectDirBtn.textContent = 'üìÅ Select Files to Organize';
                selectDescription.textContent = 'Select multiple files to organize';
                platformDescription.textContent = 'File upload mode (no directory access on iOS)';
                // Disable move mode on mobile
                if (organizationMode === 'move') {
                    copyModeBtn.click();
                }
                moveModeBtn.disabled = true;
                moveModeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // Platform selection buttons
        const pcPlatformBtn = document.getElementById('pcPlatformBtn');
        const androidPlatformBtn = document.getElementById('androidPlatformBtn');
        const iosPlatformBtn = document.getElementById('iosPlatformBtn');

        function selectPlatform(platform) {
            platformMode = platform;

            // Update button styles
            [pcPlatformBtn, androidPlatformBtn, iosPlatformBtn].forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-300', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });

            const activeBtn = platform === 'pc' ? pcPlatformBtn :
                             platform === 'android' ? androidPlatformBtn : iosPlatformBtn;
            activeBtn.classList.remove('bg-gray-300', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            activeBtn.classList.add('bg-primary', 'text-white');

            updatePlatformUI();
        }

        pcPlatformBtn.addEventListener('click', () => selectPlatform('pc'));
        androidPlatformBtn.addEventListener('click', () => selectPlatform('android'));
        iosPlatformBtn.addEventListener('click', () => selectPlatform('ios'));

        // Initialize with detected platform
        selectPlatform(detectPlatform());

        // Mode selection buttons
        const copyModeBtn = document.getElementById('copyModeBtn');
        const moveModeBtn = document.getElementById('moveModeBtn');
        const modeDescription = document.getElementById('modeDescription');

        copyModeBtn.addEventListener('click', () => {
            organizationMode = 'copy';
            copyModeBtn.classList.remove('bg-gray-300', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            copyModeBtn.classList.add('bg-primary', 'text-white');
            moveModeBtn.classList.remove('bg-primary', 'text-white');
            moveModeBtn.classList.add('bg-gray-300', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            modeDescription.textContent = 'Originals will be preserved (copies created)';
        });

        moveModeBtn.addEventListener('click', () => {
            if (platformMode !== 'pc') return; // Only allow move mode on PC
            organizationMode = 'move';
            moveModeBtn.classList.remove('bg-gray-300', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            moveModeBtn.classList.add('bg-primary', 'text-white');
            copyModeBtn.classList.remove('bg-primary', 'text-white');
            copyModeBtn.classList.add('bg-gray-300', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            modeDescription.textContent = 'Originals will be removed (moved to organized folders)';
        });

        // Handle mobile file selection
        const mobileFileInput = document.getElementById('mobileFileInput');
        mobileFileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);

            if (files.length === 0) {
                return;
            }

            // Show loading
            document.getElementById('selectSection').classList.add('hidden');
            document.getElementById('loadingSection').classList.remove('hidden');

            // Process files
            selectedFiles = files.map(file => ({
                name: file.name,
                path: file.name,
                category: getFileCategory(file.name),
                file: file
            }));

            // Display results (no dirs for mobile)
            displayResults(selectedFiles, []);
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
        });

        // Event listeners
        document.getElementById('selectDirBtn').addEventListener('click', async () => {
            // Mobile platforms use file input
            if (platformMode === 'android' || platformMode === 'ios') {
                mobileFileInput.click();
                return;
            }

            // PC uses directory picker
            try {
                // Check if File System Access API is supported
                if (!('showDirectoryPicker' in window)) {
                    showAlert('Your browser does not support the File System Access API. Please use a modern browser like Chrome or Edge.');
                    return;
                }

                directoryHandle = await window.showDirectoryPicker({
                    mode: 'readwrite'
                });

                // Show loading
                document.getElementById('selectSection').classList.add('hidden');
                document.getElementById('loadingSection').classList.remove('hidden');

                // Scan directory
                const { files, dirs } = await scanDirectory(directoryHandle);

                if (files.length === 0 && dirs.length === 0) {
                    showAlert('No files or folders found in the selected directory.');
                    document.getElementById('loadingSection').classList.add('hidden');
                    document.getElementById('selectSection').classList.remove('hidden');
                    return;
                }

                // Display results
                displayResults(files, dirs);
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');

            } catch (error) {
                console.error('Error selecting directory:', error);
                if (error.name !== 'AbortError') {
                    showAlert('Error accessing directory. Please make sure you grant the necessary permissions.');
                }
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('selectSection').classList.remove('hidden');
            }
        });

        document.getElementById('organizeBtn').addEventListener('click', async () => {
            // Show loading
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('loadingSection').querySelector('p').textContent = 'Organizing files...';

            if (platformMode === 'pc') {
                await organizeFiles();
            } else {
                await organizeFilesMobile();
            }

            document.getElementById('loadingSection').classList.add('hidden');
        });

        document.getElementById('scanAgainBtn').addEventListener('click', () => {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('selectSection').classList.remove('hidden');
            fileMap = new Map();
            subdirectories = [];
            selectedFiles = [];
        });

        document.getElementById('organizeAnotherBtn').addEventListener('click', () => {
            document.getElementById('successSection').classList.add('hidden');
            document.getElementById('selectSection').classList.remove('hidden');
            fileMap = new Map();
            subdirectories = [];
            selectedFiles = [];
        });
    </script>


</body></html>